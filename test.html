<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <title>Mini App</title>

    <style>
      body {
        background-color: white;
        margin: 15px;
        font-size: 20px;
      }
      
      div.select {
        margin-top: 50px;
      }

      .select select {
        padding: 10px;
        font-size: 18px;
        margin-bottom: 10px;
      }
      
      div.conversion {
        margin: 25px 0 25px 0;
      }
      
      button {
        padding: 10px 61px;
        font-size: 21px;
      }
      
    </style>
  </head>
  <body>
    <h1>GanDollarz</h1>
    <div class="select select-currency">
      <select class="select-text">
        <option disabled selected> Choose Currency </option>
      </select>
    </div>
    
    <button class="btn"> In Naira </button>
    
    <div class="conversion mdc-elevation--z3"></div>
    
    <div class="messages"> </div>
    <script>
      
      const currencies = [{
        id: 'USD', name: 'US Dollars'
      }, {
        id: 'UGX', name: 'Ugandan Shillings'
      }, {
        id: 'KES', name: 'Kenyan Shillings'
      }, {
        id: 'GHS', name: 'Ghanian Cedi'
      }, {
        id: 'ZAR', name: 'South African Rand'
      }];
      
      const apiBase = 'https://free.currencyconverterapi.com/api/v6/';
      const api = (currency) => `
        ${apiBase}convert?q=${currency}_NGN&compact=ultra
	  `;
      
      const toast = (msg) => {
        const toastr = document.querySelector('.messages');
        if(!toastr) return;
        
        toastr.textContent = msg;
        if(!toastr.classList.contains('on')) {
          toastr.classList.add('on');
        }
      };
      
      const doneToasting = () => {
        const toastr = document.querySelector('.messages');
        if(!toastr) return;
        
        toastr.textContent = '';
        toastr.classList.remove('on');
      };
      
      const conversionSucceeded = (apiResponse) => {
        if(!apiResponse) {
          toast(`nothing to display ...`);
          return;
        }
        
        const [value] = Object.values(apiResponse)
        
        const btn = document.querySelector('button');
        btn.removeAttribute('disabled');
        
        const display = document.querySelector('.conversion');
        const formatter = new Intl.NumberFormat(
          'en-NG', { style: 'currency', currency: 'NGN' }
        );
        
        display.textContent = formatter.format(value);
        doneToasting();
      };
      
       
      const populateCurrencies = () => {
        currencies.forEach( (value,index)=>{
          let option = document.createElement("option");
          option.setAttribute("value", value.id);
          option.appendChild(document.createTextNode(value.name));
        document.getElementsByClassName("select-text")[0].appendChild(option);
        });
      }    
      
      const getSelectedCurrency = () => {
        let e = document.getElementsByClassName("select-text")[0];
        return e.options[e.selectedIndex].value;
      };
            
      const convert = (event) => {
        toast(`preparing to convert ...`);
      
        const btn = event ? 
              event.target : document.querySelector('button');
        
        const selected = getSelectedCurrency();

        console.log(selected);
        
        if(!selected || selected.trim() === '' 
           || !currencies.map(c => c.id).includes(selected)) return;
        
        btn.setAttribute('disabled', 'disabled');
        toast(`converting ...`);
        
        const endpoint = api(selected);
        

        // make a GET fetch call to the endpoint
        // variable declared above, convert the response to JSON,
        // then call conversionSucceeded and pass the JSON data to it
        
        fetch(endpoint,{method: "GET"})
        .then(response => {return response.json();})
        .then(theJson => {conversionSucceeded(theJson);})

/***
        Within the 'convert' function, make a fetch call to the URL declared as the 'endpoint' variable. Convert the response to JSON, then call 'conversionSucceeded' and pass the JSON data to it
**/
      };
    

      const startApp = () => {
        // call populateCurrencies here
        populateCurrencies();
      
        let docBtn = document.getElementsByClassName("btn")[0];
        docBtn.onclick = function(){
          convert(event)
        } 
      };

      startApp();
    </script>
  </body>
</html>

